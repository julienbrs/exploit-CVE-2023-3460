IMAGE_NAME=localwordpress
CONTAINER_NAME=wordpress-container
INIT_SCRIPT=/usr/local/bin/initialize_wordpress.sh
WP_INSTALL_URL=http://localhost:80/wp-admin/install.php
DOCKER_COMPOSE=docker compose	# TODO: Use docker-compose instead of docker ? How to handle both?

# Set up the environment for the exploitd
up:
	$(DOCKER_COMPOSE) -f docker-compose.yml up -d
	@echo "Waiting for Wordpress installation..."
	while ! docker exec $(CONTAINER_NAME) curl -s $(WP_INSTALL_URL) | grep -q '<title>WordPress &rsaquo; Installation</title>'; do \
		echo "Waiting..."; \
		sleep 5; \
	done
	@echo "Setup Wordpress..."
	docker exec $(CONTAINER_NAME) $(INIT_SCRIPT)
	@echo "Setting up Python environment and installing dependencies..."
	docker compose -f ./docker-compose-setup.yml up

# Run the exploit to create a new admin user
exploit:
	docker compose -f ./docker-compose-attacker.yml up

# Clean up the environment
down:
	$(DOCKER_COMPOSE) down

# Run a bash shell in the container running Wordpress
bash:
	docker exec -it $(CONTAINER_NAME) /bin/bash

# Stop the containers running Wordpress
stop:
	$(DOCKER_COMPOSE) stop

# Show the logs from the container running Wordpress
logs:
	docker logs exploit-cve-2023-3460_wordpress_1

