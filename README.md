# Analyse et exploitation de la CVE-2023-3460

| CVE ID       | CVSS Score      | Discovered   | Affected Plugin | Vulnerability Type        |
|--------------|-----------------|--------------|-----------------|---------------------------|
| CVE-2023-3460| ![Critical](https://img.shields.io/badge/9.1-Critical-red)   | 07/04/2023   | Ultimate Member | Unauthorized Admin Access |


## Sommaire

- [Quick start docker compose](#quick-start-docker-compose)
- [Manipulation manuelle](#manipulation-manuelle)
- [Description](#description)
- [Analyse](#analyse)
- [Réseau](#réseau)
- [Scénarios](#scénarios)
- [Mesures](#mesures)
- [Sources](#sources)

## Quick start

Un Makefile est disponible pour vous aider à lancer l'exploitation de la faille. Vous pouvez l'utiliser comme suit:

- `make up` pour lancer Wordpress avec toute les installations nécessaires.
Il vous sera alors possible de vous connecter à Wordpress sur la page [Login](http://localhost:8000/wp-login.php?) avec les identifiants `admin:password`. En allant sur l'onglet [Users](http://localhost:8000/wp-admin/users.php), vous pourrez voir
que uniquement l'utilisateur `admin` est présent.
Note: si vous avez `docker compose` et non `docker-compose` vous pouvez modifier le Makefile en conséquence (variable DOCKER_COMPOSE).

Puis, vous pouvez lancer l'exploitation de la faille:
- `make exploit`
Vous pourrez alors vous connecter à Wordpress sur [Login](http://localhost:8000/wp-login.php?) avec les identifiants donnés par l'exploit et observer dans l'onglet [Users](http://localhost:8000/wp-admin/users.php) qu'un nouvel utilisateur a été créé avec le rôle `Administrator`.

## Description

La bibliothèque go-libp2p est une implémentation de la stack réseau libp2p en Go. Cette bibliothèque est maintenue par [IPFS](https://ipfs.tech/), projet qui se définit comme l'internet décentralisé.

La vulnérabilité présentée dans ce repository concerne les versions de la bibliothèque golang go-libp2p antérieures (<) à la version 0.19.12, et les versions 1.20.0 (>=) à 1.20.7(<). **ATTENTION**: en réalité, golang entier est vulnérable à cette faille, mais nous nous sommes concentrés sur la bibliothèque go-libp2p, qui fait usage des parties de la librairie standard qui provoquent la faille.

Dans ces versions de la bibliothèque et lorsqu'un noeud du réseau utilise une trop grosse clé RSA, des attaquants peuvent effectuer des connexions à répétitions et provoquer une attaque par épuisement des ressources (DDOS).
A cause de cette longue clé RSA, le noeud va utiliser une grande quantité de ressource pour initialiser la connexion avec l'attaquant.  

La solution implémentée pour corriger cette faille est d'avoir limité la taille des clés RSA à 8192 bits, il s'agit donc plus d'un workaround qu'un fix. Il n'existe pas de fix connu à cette vulnérabilité.

## Analyse

#### 1. Indiquer quel est le service ou le programme compromis, quel est le type de compromission

Le plugin "Ultimate Member" de Wordpress est compromis avant la version 2.6.7. Il s'agit d'un plugin largement utilisé pour la gestion des profils utilisateurs sur les sites WordPress. La compromission en question est une vulnérabilité de type "escalade de privilèges" (privilege escalation).

#### 2. Expliquer la vulnérabilité, décrire le mécanisme permettant de l’exploiter.

L'escalade de privilèges est due à une faille dans le traitement des données utilisateurs.

Le mécanisme d’exploitation repose sur la manipulation du champ "wp_capabilities" durant le processus d'inscription d'un nouvel utilisateur sur le site. En modifiant ce champ par l'intermédiaire d'une requête POST, un attaquant peut injecter un payload qui modifie la valeur de "wp_capabilities" pour s'octroyer les droits administratifs.

Le plugin, dans les versions vulnérables, n’effectue pas correctement la vérification de cette valeur, permettant ainsi à l'attaquant de contourner les contrôles de sécurité normaux. En utilisant des caractères accentués, tels que "à, è, ì, ò, ù", l'attaquant peut éviter que la fonction de sécurité "is_metakey_banned" bloque la modification.
Une fois le champ "wp_capabilities" modifié avec succès pour refléter les droits d'administrateur, l'attaquant peut se connecter avec des privilèges étendus et effectuer des actions réservées normalement aux administrateurs, telles que la modification de contenu, l'injection de code malveillant, ou encore le vol de données sensibles des utilisateurs.


#### 3. Cette faille concerne-t-elle des machines clientes ou des machines serveurs ?

La faille concerne les machines serveurs hébergeant des sites WordPress utilisant le plugin Ultimate Member. Les machines clientes qui accèdent à ces sites web ne sont pas directement affectées par la vulnérabilité elle-même, mais elles peuvent être impactées indirectement si le site auquel elles accèdent a été compromis.

#### 4. Décrire une architecture typique du système d’information qui pourrait être impliquée dans l’exploitation de ces failles.

TODO

#### 5. Que préconiseriez-vous au niveau du rapport pour :

  - limiter l’impact de l’exploitation de ces failles ?

Appliquer le principe de moindre privilège pour limiter l'accès et les droits des utilisateurs selon leur nécessité.
Cependant, cela ne suffit pas à limiter l'impact de l'exploitation de cette faille, car elle permet à un attaquant d'obtenir les droits d'administrateur, ce qui lui donne accès à toutes les fonctionnalités du site.
Il n'existe donc pas de moyen efficace pour prévenir son exploitation.

  - empêcher qu’elles ne puissent être exploitées ?

Application du Patch : La manière la plus directe d'empêcher l'exploitation de cette faille est d'appliquer le patch fourni. Ce patch ajuste la fonction `is_metakey_banned` pour qu'elle tienne compte des métadonnées avec des caractères accentués, empêchant ainsi cette méthode spécifique d'exploitation de la vulnérabilité.

#### 6. Référencer parmi les bonnes pratiques, celles qu’il faudrait utiliser pour limiter cette menace.

Une bonne pratique évidente: mise à jour immédiates des plugins installés. Ainsi, ne pas utiliser de plugins obsolètes, et ne pas utiliser de plugins qui ne sont plus maintenus.

#### 7. S’il s’agit d’une faille issue d’un développement, indiquer ce qu’il aurait fallu mettre en place dans les équipes de développement pour limiter l’apparition d’une telle faille.

Il aurait fallu des tests plus poussés sur les entrées utilisateurs, et une meilleure gestion des erreurs. Pour cela, des audits de code et des tests de pénétration auraient pu être mis en place.
De plus, il aurait fallu une validation stricte et une sanitisation des entrées utilisateur pour prévenir les injections malveillantes.

#### 8. Pour le produit étudié, définir une cible de sécurité (Utilisateurs, Biens à protéger, Menaces, fonctions de sécurité, …)

- **Utilisateurs :** Les administrateurs de sites WordPress utilisant le plugin Ultimate Member, ainsi que les utilisateurs finaux des sites concernés.

- **Biens à Protéger :** Données Personnelles des Utilisateurs : Informations de profil, données de contact, mots de passe.
    Intégrité du Site Web : Contenu du site, paramètres de configuration, réputation en ligne.

- **Menaces :** Accès Non Autorisé : Obtention de droits administratifs par des acteurs malveillants.
    Modification de Contenu : Changements non autorisés ou suppression de contenu.
    Injection de Code Malveillant : Insertion de scripts ou redirections vers des sites malveillants.
    Vol de Données : Accès et exfiltration de données sensibles.

- **Fonctions de Sécurité :** Authentification Forte : Mise en place d’une authentification multi-facteurs.
    Contrôle d'Accès : Restriction des droits d’utilisateur basée sur les rôles.
    Audit et Journalisation : Suivi des activités pour détecter des comportements anormaux.
    Chiffrement : Protection des données sensibles stockées et transmises.

- **Mesures Préventives :** Mises à jour Régulières : Application des dernières mises à jour de sécurité.
    Formation des Utilisateurs : Sensibilisation aux risques de sécurité et aux bonnes pratiques.

#### 9. Pour cette faille proposer une expérimentation permettant de mettre en évidence la vulnérabilité et son exploitation :

Référez-vous au [Quick start](#quick-start) pour lancer l'exploitation de la faille.

## Sources

| Nom             | Lien                                                                |
| ----------------- | ------------------------------------------------------------------ |
| NIST CVE-2023-3460 | https://nvd.nist.gov/vuln/detail/CVE-2023-3460 |
| Ultimate Member Github | https://github.com/ultimatemember/ultimatemember |
| Version du package utilisé pour l'exploitation 2.6.5 | https://wordpress.org/plugins/ultimate-member/advanced/ |
| Patch of the exploit | https://github.com/ultimatemember/ultimatemember/commit/fae47c6065ce07e9a8b44501002fa5b4f16d2456 |
|
